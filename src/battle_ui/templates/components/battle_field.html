<!-- ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
<div class="fade-in">
    <!-- ã‚¿ãƒ¼ãƒ³è¡¨ç¤º & æ“ä½œãƒãƒ¼ -->
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-4">
            <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-bold">
                ã‚¿ãƒ¼ãƒ³ {{ state.turn }}
            </span>

            <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çŠ¶æ…‹ -->
            {% if state.field.weather %}
            <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-sm">
                {{ state.field.weather }}
            </span>
            {% endif %}
            {% if state.field.terrain %}
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm">
                {{ state.field.terrain }}
            </span>
            {% endif %}
            {% if state.field.trick_room %}
            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded text-sm">
                ãƒˆãƒªãƒƒã‚¯ãƒ«ãƒ¼ãƒ 
            </span>
            {% endif %}
        </div>

        <div class="flex items-center gap-2">
            <!-- AIåˆ†æãƒˆã‚°ãƒ« -->
            {% if state.ai_mode == "rebel" %}
            {% if state.ai_analysis_always_on %}
            <!-- å¸¸æ™‚ONãƒ¢ãƒ¼ãƒ‰ï¼šãƒœã‚¿ãƒ³ã¯å¸¸ã«ONçŠ¶æ…‹ -->
            <span class="bg-purple-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-1">
                <span>ğŸ¤–</span>
                <span>AIåˆ†æ å¸¸æ™‚ON</span>
            </span>
            {% else %}
            <!-- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šãƒˆã‚°ãƒ«å¯èƒ½ -->
            <button id="ai-analysis-toggle"
                    onclick="toggleAiAnalysis('{{ session_id }}')"
                    class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm transition-colors flex items-center gap-1">
                <span>ğŸ¤–</span>
                <span id="ai-toggle-text">AIåˆ†æ</span>
            </button>
            {% endif %}
            {% endif %}

            <button hx-post="/api/battle/{{ session_id }}/surrender"
                    hx-target="#battle-container"
                    hx-confirm="æœ¬å½“ã«é™å‚ã—ã¾ã™ã‹ï¼Ÿ"
                    hx-indicator="#loading"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                é™å‚
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ -->
    <div class="grid lg:grid-cols-3 gap-4">
        <!-- å·¦: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ -->
        <div class="space-y-4">
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-sm text-gray-500 mb-3">ã‚ãªãŸã®ãƒã‚±ãƒ¢ãƒ³</h3>

                <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚±ãƒ¢ãƒ³ -->
                {% if state.player_active %}
                {% set pokemon = state.player_active %}
                {% set is_active = True %}
                {% set is_player = True %}
                {% include "components/pokemon_card.html" %}
                {% endif %}

                <!-- ãƒ™ãƒ³ãƒ -->
                <div class="grid grid-cols-2 gap-2 mt-3">
                    {% for bench_pokemon in state.player_bench %}
                    {% set pokemon = bench_pokemon %}
                    {% set is_active = False %}
                    {% set is_player = True %}
                    {% include "components/pokemon_card.html" %}
                    {% endfor %}
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åŠ¹æœ -->
            {% if state.field.player_side %}
            {% set side = state.field.player_side %}
            {% set label = "å‘³æ–¹" %}
            {% include "components/field_effects.html" %}
            {% endif %}
        </div>

        <!-- ä¸­å¤®: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ & ãƒ­ã‚° -->
        <div class="space-y-4">
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« -->
            {% if state.available_actions %}
            {% include "components/action_panel.html" %}
            {% endif %}

            <!-- ãƒãƒˆãƒ«ãƒ­ã‚° -->
            {% include "components/battle_log.html" %}
        </div>

        <!-- å³: ç›¸æ‰‹å´ -->
        <div class="space-y-4">
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-sm text-gray-500 mb-3">ç›¸æ‰‹ã®ãƒã‚±ãƒ¢ãƒ³</h3>

                <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚±ãƒ¢ãƒ³ -->
                {% if state.opponent_active %}
                {% set pokemon = state.opponent_active %}
                {% set is_active = True %}
                {% set is_player = False %}
                {% include "components/pokemon_card.html" %}
                {% endif %}

                <!-- æ§ãˆãƒã‚±ãƒ¢ãƒ³ï¼ˆåå‰ã®ã¿ã€è©³ç´°ã¯éå…¬é–‹ï¼‰ -->
                <div class="mt-3 text-sm text-gray-400">
                    <div class="flex items-center gap-2">
                        <span>æ§ãˆ:</span>
                        <span>{{ state.opponent_bench | length }}åŒ¹</span>
                    </div>
                </div>
            </div>

            <!-- ç›¸æ‰‹å´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åŠ¹æœ -->
            {% if state.field.opponent_side %}
            {% set side = state.field.opponent_side %}
            {% set label = "ç›¸æ‰‹" %}
            {% include "components/field_effects.html" %}
            {% endif %}
        </div>
    </div>

    <!-- AIåˆ†æãƒ‘ãƒãƒ«ï¼ˆãƒˆã‚°ãƒ«ã§è¡¨ç¤º/éè¡¨ç¤ºã€å¸¸æ™‚ONã®å ´åˆã¯æœ€åˆã‹ã‚‰è¡¨ç¤ºï¼‰ -->
    {% if state.ai_mode == "rebel" %}
    <div id="ai-analysis-panel" class="mt-4 {% if not state.ai_analysis_always_on %}hidden{% endif %}">
        <div id="ai-analysis-content">
            <!-- AIåˆ†æãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ -->
        </div>
    </div>
    {% endif %}
</div>

<!-- AIåˆ†æãƒˆã‚°ãƒ«ç”¨JavaScript -->
<script>
    (function() {
        const AI_ANALYSIS_ALWAYS_ON = {{ state.ai_analysis_always_on | tojson }};
        const CURRENT_SESSION_ID = '{{ session_id }}';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼ˆãƒœã‚¿ãƒ³ã®onclickã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
        window.loadAiAnalysis = function(sessionId) {
            const content = document.getElementById('ai-analysis-content');
            if (!content) return;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            content.innerHTML = '<div class="text-gray-500 text-sm">åˆ†æä¸­...</div>';

            fetch(`/api/battle/${sessionId}/ai-analysis`)
                .then(response => response.text())
                .then(html => {
                    const contentEl = document.getElementById('ai-analysis-content');
                    if (contentEl) contentEl.innerHTML = html;
                })
                .catch(err => {
                    const contentEl = document.getElementById('ai-analysis-content');
                    if (contentEl) contentEl.innerHTML = '<div class="text-red-500 text-sm">åˆ†æãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                });
        };

        window.toggleAiAnalysis = function(sessionId, forceState) {
            forceState = forceState !== undefined ? forceState : null;
            const panel = document.getElementById('ai-analysis-panel');
            const toggleText = document.getElementById('ai-toggle-text');
            const toggleBtn = document.getElementById('ai-analysis-toggle');

            if (!panel) return;

            // å¸¸æ™‚ONãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒˆã‚°ãƒ«ä¸å¯
            if (AI_ANALYSIS_ALWAYS_ON) {
                window.loadAiAnalysis(sessionId);
                return;
            }

            if (!toggleBtn) return;

            let visible = sessionStorage.getItem(`ai_analysis_${sessionId}`) === 'true';
            if (forceState !== null) {
                visible = forceState;
            } else {
                visible = !visible;
            }

            // çŠ¶æ…‹ã‚’ä¿å­˜
            sessionStorage.setItem(`ai_analysis_${sessionId}`, visible);

            if (visible) {
                panel.classList.remove('hidden');
                toggleBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                toggleBtn.classList.add('bg-purple-700', 'hover:bg-purple-800');
                if (toggleText) toggleText.textContent = 'AIåˆ†æ ON';
                window.loadAiAnalysis(sessionId);
            } else {
                panel.classList.add('hidden');
                toggleBtn.classList.remove('bg-purple-700', 'hover:bg-purple-800');
                toggleBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                if (toggleText) toggleText.textContent = 'AIåˆ†æ';
            }
        };

        // AIåˆ†æã®åˆæœŸåŒ–
        function initAiAnalysis() {
            const sessionId = CURRENT_SESSION_ID;
            const panel = document.getElementById('ai-analysis-panel');

            if (!panel) return;

            if (AI_ANALYSIS_ALWAYS_ON) {
                // å¸¸æ™‚ONãƒ¢ãƒ¼ãƒ‰
                panel.classList.remove('hidden');
                window.loadAiAnalysis(sessionId);
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
                const wasVisible = sessionStorage.getItem(`ai_analysis_${sessionId}`);
                if (wasVisible === 'true') {
                    window.toggleAiAnalysis(sessionId, true);
                }
            }
        }

        // å³åº§ã«å®Ÿè¡Œ
        initAiAnalysis();
    })();
</script>
